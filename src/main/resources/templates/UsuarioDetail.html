<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

    <head>
        <title>Detalle del Usuario</title>

        <style>
            .bg-soft-primary {
                background: rgba(13, 110, 253, .08);
            }

            .card-elev {
                box-shadow: 0 12px 28px rgba(0, 0, 0, .08);
            }

            .avatar-lg {
                width: 140px;
                height: 140px;
                object-fit: cover;
            }

            .truncate-1 {
                max-width: 420px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .section-title {
                letter-spacing: .2px;
            }
        </style>
    </head>

    <body class="bg-light">
        <div class="container my-4" layout:fragment="contenido">

            <!-- Encabezado de página -->
            <div class="card border-0 rounded-4 card-elev mb-4 overflow-hidden">
                <div class="p-3 p-md-4 bg-primary text-white">
                    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <span class="rounded-3 p-2 bg-white bg-opacity-25 d-inline-flex">
                                <i class="bi bi-person-vcard-fill fs-4"></i>
                            </span>
                            <div>
                                <h1 class="h4 fw-bold mb-0">Detalle del Usuario</h1>
                                <p class="mb-0 opacity-75 small">Consulta y administra información y direcciones.</p>
                                <input type="hidden" id="Token" name="Token" th:value="${token}">
                            </div>
                        </div>

                        <div class="d-flex gap-2 flex-wrap">
                            <a class="btn btn-light btn-sm rounded-pill fw-semibold px-3" th:href="@{/usuario}">
                                <i class="bi bi-arrow-left me-2"></i>Volver
                            </a>
                            <button type="button" class="btn btn-warning btn-sm rounded-pill fw-semibold px-3" data-bs-toggle="modal"
                                    data-bs-target="#modalModificarUsuario">
                                <i class="bi bi-pencil-square me-2"></i>Modificar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="p-2 p-md-3 bg-white">
                    <div class="row g-3 align-items-stretch">
                        <div class="col-12 col-md-4">
                            <div class="p-3 rounded-4 bg-soft-primary border h-100 d-flex flex-column">
                                <div class="d-flex align-items-center gap-2 text-primary fw-bold">
                                    <i class="bi bi-person-badge"></i><span>Usuario</span>
                                </div>

                                <div class="mt-2 fw-bold truncate-1">
                                    <span th:text="${usuario.Nombre}">Nombre</span>
                                    <span th:text="${usuario.ApellidoPaterno}">Apellido</span>
                                    <span th:text="${usuario.ApellidoMaterno}">Apellido</span>
                                </div>

                                <div class="text-muted small mt-auto pt-2">
                                    <i class="bi bi-at me-1"></i><span th:text="${usuario.UserName}">username</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 col-md-4">
                            <div class="p-3 rounded-4 bg-light border h-100 d-flex flex-column">
                                <div class="d-flex align-items-center gap-2 fw-bold">
                                    <i class="bi bi-shield-check text-primary"></i><span>Rol</span>
                                </div>

                                <div class="mt-auto pt-2">
                                    <span class="badge text-bg-primary rounded-pill px-3 py-2">
                                        <span th:text="${usuario.rol != null ? usuario.rol.nombre : 'N/D'}">Rol</span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 col-md-4">
                            <div class="p-3 rounded-4 bg-light border h-100 d-flex flex-column">
                                <div class="d-flex align-items-center gap-2 fw-bold">
                                    <i class="bi bi-toggle-on text-success"></i><span>Estatus</span>
                                </div>

                                <div class="mt-auto pt-2">
                                    <span th:if="${usuario.Status}" class="badge text-bg-success rounded-pill px-3 py-2">
                                        <i class="bi bi-check-circle me-1"></i>Activo
                                    </span>
                                    <span th:unless="${usuario.Status}" class="badge text-bg-secondary rounded-pill px-3 py-2">
                                        <i class="bi bi-x-circle me-1"></i>Inactivo
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>


                <div class="row g-4">

                    <!-- Perfil -->
                    <div class="col-lg-4 col-12">
                        <div class="card border-0 rounded-4 card-elev h-100">
                            <div class="card-body p-4">

                                <div class="text-center">
                                    <div class="d-inline-block border rounded-circle p-1 shadow-sm bg-white">
                                        <img id="imgUsuarioMain"
                                             th:src="${(usuario.Imagen != null and usuario.Imagen.length() > 0) ? 'data:image/jpeg;base64,' + usuario.Imagen : 'https://via.placeholder.com/160?text=Usuario'}"
                                             alt="Foto del usuario" class="rounded-circle img-fluid avatar-lg" />
                                    </div>

                                    <div class="mt-3">
                                        <div class="fw-bold fs-5 text-primary">
                                            <span th:text="${usuario.Nombre}">Nombre</span>
                                            <span th:text="${usuario.ApellidoPaterno}">Apellido</span>
                                        </div>
                                        <div class="text-muted">
                                            <i class="bi bi-at me-1"></i><span th:text="${usuario.UserName}">username</span>
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-4">

                                <h6 class="fw-bold text-secondary section-title mb-3">
                                    <i class="bi bi-info-circle me-2"></i>Información General
                                </h6>

                                <div class="d-flex flex-column gap-3">

                                    <div class="p-3 rounded-4 bg-light border">
                                        <div class="d-flex align-items-center gap-2 fw-bold">
                                            <i class="bi bi-envelope text-primary"></i><span>Correo</span>
                                        </div>
                                        <div class="mt-1 truncate-1" th:text="${usuario.Email}">correo@dominio.com</div>
                                    </div>

                                    <div class="p-3 rounded-4 bg-light border">
                                        <div class="d-flex align-items-center gap-2 fw-bold">
                                            <i class="bi bi-telephone text-secondary"></i><span>Teléfono</span>
                                        </div>
                                        <div class="mt-1" th:text="${usuario.Telefono}">5551234567</div>
                                    </div>

                                    <div class="p-3 rounded-4 bg-light border">
                                        <div class="d-flex align-items-center gap-2 fw-bold">
                                            <i class="bi bi-phone text-success"></i><span>Celular</span>
                                        </div>
                                        <div class="mt-1" th:text="${usuario.Celular}">5587654321</div>
                                    </div>

                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- Direcciones -->
                    <div class="col-lg-8 col-12">
                        <div class="card border-0 rounded-4 card-elev h-100 overflow-hidden">
                            <div class="card-header bg-white border-0 p-4">
                                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                                    <div class="fw-bold fs-5">
                                        <i class="bi bi-geo-alt-fill text-primary me-2"></i>Direcciones Asignadas
                                    </div>

                                    <button type="button" class="btn btn-success rounded-pill fw-semibold px-4" data-bs-toggle="modal"
                                            data-bs-target="#modalDireccion" onclick="FormDireccionNueva()">
                                        <i class="bi bi-plus-circle-fill me-2"></i>Agregar Dirección
                                    </button>
                                </div>
                                <div class="text-muted small mt-2">
                                    Tip: Expande una dirección para ver más y editarla.
                                </div>
                            </div>

                            <div class="card-body p-4 pt-0">

                                <div class="alert alert-info border-0 rounded-4 shadow-sm mt-3"
                                     th:if="${usuario.Direcciones == null or usuario.Direcciones.isEmpty()}">
                                    <i class="bi bi-info-circle me-2"></i>Este usuario no tiene direcciones registradas.
                                </div>

                                <div class="accordion mt-3" id="accordionDirecciones"
                                     th:if="${usuario.Direcciones != null and !usuario.Direcciones.isEmpty()}">

                                    <div class="accordion-item border-0 rounded-4 shadow-sm mb-3"
                                         th:each="direccion, iter : ${usuario.Direcciones}">

                                        <h2 class="accordion-header" th:id="|heading-${direccion.IdDireccion}|">
                                            <button class="accordion-button collapsed rounded-4 fw-semibold" type="button"
                                                    data-bs-toggle="collapse" th:attr="data-bs-target=|#collapse-${direccion.IdDireccion}|,
                                                    aria-controls=|collapse-${direccion.IdDireccion}|">
                                                <div class="d-flex align-items-center gap-3 w-100">
                                                    <span class="badge text-bg-primary rounded-circle p-2">
                                                        <i class="bi bi-geo-alt"></i>
                                                    </span>

                                                    <div class="min-w-0">
                                                        <div class="truncate-1">
                                                            <span th:text="${direccion.Calle}">Calle</span>
                                                            <span th:text="| #${direccion.NumeroExterior}|">#0</span>
                                                            <span th:if="${direccion.NumeroInterior}"
                                                                  th:text="| Int. ${direccion.NumeroInterior}|"></span>
                                                        </div>
                                                        <div class="text-muted small truncate-1">
                                                            <span
                                                                th:text="${direccion.colonia != null ? direccion.colonia.nombre : 'N/D'}">Colonia</span>
                                                            ·
                                                            <span
                                                                th:text="${(direccion.colonia != null and direccion.colonia.municipio != null) ? direccion.colonia.municipio.nombre : 'N/D'}">Municipio</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </button>
                                        </h2>

                                        <div class="accordion-collapse collapse" th:id="|collapse-${direccion.IdDireccion}|"
                                             th:attr="aria-labelledby=|heading-${direccion.IdDireccion}|" data-bs-parent="#accordionDirecciones">
                                            <div class="accordion-body bg-light rounded-bottom-4">

                                                <div class="row g-3 align-items-start">
                                                    <div class="col-12 col-md-8">
                                                        <div class="p-3 bg-white border rounded-4">
                                                            <div class="fw-bold mb-1">
                                                                <i class="bi bi-house-door me-2 text-primary"></i>Detalle
                                                            </div>
                                                            <div class="text-muted small">
                                                                Colonia:
                                                                <span
                                                                    th:text="${direccion.colonia != null ? direccion.colonia.nombre : 'N/D'}"></span><br />
                                                                Mpo/Edo:
                                                                <span
                                                                    th:text="${(direccion.colonia != null and direccion.colonia.municipio != null) ? direccion.colonia.municipio.nombre : 'N/D'}"></span>,
                                                                <span
                                                                    th:text="${(direccion.colonia != null and direccion.colonia.municipio != null and direccion.colonia.municipio.estado != null) ? direccion.colonia.municipio.estado.nombre : 'N/D'}"></span><br />
                                                                País:
                                                                <span
                                                                    th:text="${(direccion.colonia != null and direccion.colonia.municipio != null and direccion.colonia.municipio.estado != null and direccion.colonia.municipio.estado.pais != null) ? direccion.colonia.municipio.estado.pais.nombre : 'N/D'}"></span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-12 col-md-4">
                                                        <div class="d-flex gap-2 justify-content-md-end">
                                                            <button type="button" class="btn btn-outline-primary rounded-pill fw-semibold"
                                                                    data-bs-toggle="modal" data-bs-target="#modalDireccion"
                                                                    th:attr="onclick=|FormDireccionEditable(${direccion.IdDireccion})|">
                                                                <i class="bi bi-pencil me-1"></i>Editar
                                                            </button>

                                                            <button type="button"
                                                                    class="btn btn-outline-danger rounded-pill fw-semibold btn-delete-direccion"
                                                                    th:attr="data-direccion-id=${direccion.IdDireccion},data-usuario-id=${usuario.IdUsuario}">
                                                                <i class="bi bi-trash me-1"></i>Eliminar
                                                            </button>
                                                        </div>
                                                    </div>

                                                </div>

                                            </div>
                                        </div>
                                    </div>

                                </div>

                            </div>
                        </div>
                    </div>

                </div>

                <!-- Modal: Modificar usuario -->
                <div class="modal fade" id="modalModificarUsuario" tabindex="-1" aria-labelledby="modalModificarUsuarioLabel"
                     aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content rounded-4">
                            <div class="modal-header bg-primary text-white rounded-top-4">
                                <h5 class="modal-title fw-bold" id="modalModificarUsuarioLabel">
                                    <i class="bi bi-person-lines-fill me-2"></i>Modificar Datos de Usuario
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                            </div>

                            <div class="modal-body p-4">
                                <form th:action="@{/usuario/update}" method="post" th:object="${usuario}" enctype="multipart/form-data"
                                      novalidate>
                                    <input type="hidden" th:field="*{IdUsuario}" />

                                    <div class="row g-3 align-items-center mb-3">
                                        <div class="col-md-3 text-center">
                                            <div class="d-inline-block border rounded-circle p-1 shadow-sm bg-white">
                                                <img id="imgUsuarioPreview"
                                                     th:src="${(usuario.Imagen != null and usuario.Imagen.length() > 0) ? 'data:image/jpeg;base64,' + usuario.Imagen : 'https://via.placeholder.com/140?text=Usuario'}"
                                                     alt="Preview" class="rounded-circle img-fluid"
                                                     style="width:120px;height:120px;object-fit:cover" />
                                            </div>
                                        </div>

                                        <div class="col-md-9">
                                            <label for="ImagenFile" class="form-label fw-semibold">Foto de usuario</label>
                                            <input class="form-control" type="file" id="ImagenFile" name="ImagenFile"
                                                   accept="image/png,image/jpeg,image/jpg" />
                                            <div class="form-text">
                                                Formatos: JPG/PNG. (Opcional) Si no seleccionas una imagen, se mantiene la actual.
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mb-3 g-3">
                                        <div class="col-md-4">
                                            <label for="username" class="form-label fw-semibold">Username</label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                                                <input type="text" class="form-control" id="username" th:field="*{UserName}" readonly
                                                       style="background-color: #f8f9fa; cursor: not-allowed;" aria-describedby="usernameHelp" />
                                            </div>
                                            <div id="usernameHelp" class="form-text">El username no se puede modificar.</div>
                                        </div>

                                        <div class="col-md-4">
                                            <label for="nombre" class="form-label fw-semibold">Nombre</label>
                                            <input type="text" class="form-control" id="nombre" th:field="*{Nombre}" required
                                                   placeholder="Nombre" />
                                        </div>

                                        <div class="col-md-4">
                                            <label for="apellidoPaterno" class="form-label fw-semibold">Apellido Paterno</label>
                                            <input type="text" class="form-control" id="apellidoPaterno" th:field="*{ApellidoPaterno}" required
                                                   placeholder="Apellido Paterno" />
                                        </div>
                                    </div>

                                    <div class="row mb-3 g-3">
                                        <div class="col-md-5">
                                            <label for="apellidoMaterno" class="form-label fw-semibold">Apellido Materno</label>
                                            <input type="text" class="form-control" id="apellidoMaterno" th:field="*{ApellidoMaterno}"
                                                   placeholder="Apellido Materno" />
                                        </div>

                                        <div class="col-md-7">
                                            <label for="email" class="form-label fw-semibold">Correo Electrónico</label>
                                            <input type="email" class="form-control" id="email" th:field="*{Email}" required
                                                   placeholder="Example@correo.com" />
                                        </div>
                                    </div>

                                    <div class="row mb-3 g-3">
                                        <div class="col-md-4">
                                            <label for="sexo" class="form-label fw-semibold">Sexo</label>
                                            <select class="form-select" id="sexo" name="Sexo">
                                                <option value="" th:selected="${usuario.Sexo == null or usuario.Sexo == ''}">Seleccione...
                                                </option>
                                                <option value="M"
                                                        th:selected="${usuario.Sexo != null and #strings.toUpperCase(usuario.Sexo) == 'M'}">
                                                    Masculino
                                                </option>
                                                <option value="F"
                                                        th:selected="${usuario.Sexo != null and #strings.toUpperCase(usuario.Sexo) == 'F'}">
                                                    Femenino
                                                </option>
                                            </select>
                                        </div>

                                        <div class="col-md-4">
                                            <label for="fechaNacimiento" class="form-label fw-semibold">Fecha de Nacimiento</label>
                                            <input type="date" class="form-control" id="fechaNacimiento" th:field="*{FechaNacimiento}"
                                                   required />
                                        </div>

                                        <div class="col-md-4">
                                            <label for="curp" class="form-label fw-semibold">CURP</label>
                                            <input type="text" class="form-control" id="curp" th:field="*{CURP}" required />
                                        </div>
                                    </div>

                                    <div class="row mb-3 g-3">
                                        <div class="col-md-4">
                                            <label for="telefono" class="form-label fw-semibold">Teléfono</label>
                                            <input type="tel" class="form-control" id="telefono" maxlength="10" th:field="*{Telefono}"
                                                   placeholder="Ej: 5551234567" />
                                        </div>

                                        <div class="col-md-4">
                                            <label for="celular" class="form-label fw-semibold">Celular</label>
                                            <input type="tel" class="form-control" id="celular" maxlength="10" th:field="*{Celular}"
                                                   placeholder="Ej: 5587654321" />
                                        </div>

                                        <div class="col-md-4">
                                            <label for="pNombreRol" class="form-label fw-semibold">Rol</label>
                                            <select class="form-select" id="pNombreRol" th:field="*{Rol.IdRol}" required>
                                                <option th:each="r : ${rol}" th:value="${r.IdRol}" th:text="${r.Nombre}"></option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-end gap-2 pt-3 border-top">
                                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                                            <i class="bi bi-x-circle-fill me-1"></i>Cancelar
                                        </button>
                                        <button type="submit" class="btn btn-success rounded-pill px-4 fw-semibold">
                                            <i class="bi bi-check-circle-fill me-1"></i>Guardar Cambios
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal: Gestión de dirección -->
                <div class="modal fade" id="modalDireccion" tabindex="-1" aria-labelledby="modalDireccionLabel"
                     aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content rounded-4">
                            <div class="modal-header bg-success text-white rounded-top-4">
                                <h5 class="modal-title fw-bold" id="modalDireccionLabel">
                                    <i class="bi bi-geo-alt-fill me-2"></i>Gestión de Dirección
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-4">
                                <form id="formDireccion" th:action="@{/usuario/addDireccion}" th:object="${Direccion}" method="POST"
                                      novalidate>
                                    <input type="hidden" id="IdUsuario" name="IdUsuario" th:value="${usuario.IdUsuario}" />
                                    <input type="hidden" id="IdDireccion" name="IdDireccion" value="0" />

                                    <div class="p-3 rounded-4 bg-light border mb-3">
                                        <div class="fw-bold text-secondary">
                                            <i class="bi bi-map me-2"></i>Datos de la Dirección
                                        </div>
                                        <div class="text-muted small">Ordenado para captura rápida y clara.</div>
                                    </div>

                                    <div class="row g-3 mb-3 align-items-start">
                                        <div class="col-12 col-md-4">
                                            <label for="calle" class="form-label fw-semibold">Calle</label>
                                            <input type="text" class="form-control" id="calle" th:field="*{Calle}" placeholder="Ej. Obsidiana"
                                                   required />
                                        </div>

                                        <div class="col-12 col-md-4">
                                            <label for="numeroInterior" class="form-label fw-semibold">Número Interior</label>
                                            <input type="text" class="form-control" id="numeroInterior" th:field="*{NumeroInterior}"
                                                   placeholder="Ej. 1" />
                                        </div>

                                        <div class="col-12 col-md-4">
                                            <label for="numeroExterior" class="form-label fw-semibold d-inline-flex align-items-center gap-1"
                                                   style="white-space:nowrap;">
                                                <span>Número Exterior</span>
                                                <span class="text-muted fw-normal">(opcional)</span>
                                            </label>
                                            <input type="text" class="form-control" id="numeroExterior" th:field="*{NumeroExterior}"
                                                   placeholder="Ej. 12" />
                                        </div>
                                    </div>

                                    <div class="row g-3 mb-3">
                                        <div class="col-12 col-md-4">
                                            <label class="form-label fw-semibold" for="ddlPais">País</label>
                                            <select id="ddlPais" class="form-select">
                                                <option value="0" selected>Selecciona algún País</option>
                                                <option th:each="pais : ${paises}" th:value="${pais.IdPais}" th:text="${pais.Nombre}"></option>
                                            </select>
                                        </div>

                                        <div class="col-12 col-md-4">
                                            <label class="form-label fw-semibold" for="ddlEstado">Estado</label>
                                            <select id="ddlEstado" class="form-select">
                                                <option value="0" selected>Selecciona algún Estado</option>
                                            </select>
                                        </div>

                                        <div class="col-12 col-md-4">
                                            <label class="form-label fw-semibold" for="ddlMunicipio">Municipio</label>
                                            <select id="ddlMunicipio" class="form-select">
                                                <option value="0" selected>Selecciona algún Municipio</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="row g-3 mb-2">
                                        <div class="col-12 col-md-6">
                                            <label for="ddlColonia" class="form-label fw-semibold">Colonia</label>
                                            <select class="form-select" id="ddlColonia" name="IdColonia" required>
                                                <option value="0" selected>Seleccione una Colonia</option>
                                            </select>
                                        </div>

                                        <div class="col-12 col-md-6">
                                            <label for="ddlCodigoPostal" class="form-label fw-semibold">Código Postal</label>
                                            <select class="form-select" id="ddlCodigoPostal">
                                                <option selected>Seleccione un Código Postal</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-end gap-2 pt-3 border-top">
                                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                                            <i class="bi bi-x-circle-fill me-1"></i>Cancelar
                                        </button>
                                        <button type="submit" class="btn btn-success rounded-pill px-4 fw-semibold">
                                            <i class="bi bi-check-circle-fill me-1"></i>Guardar Dirección
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

            <script>
                                                const API_BASE = "http://localhost:8080";

                                                $(document).on("change", "#ImagenFile", function () {
                                                    const file = this.files && this.files[0] ? this.files[0] : null;
                                                    if (!file)
                                                        return;

                                                    const okTypes = ["image/jpeg", "image/jpg", "image/png"];
                                                    if (!okTypes.includes(file.type)) {
                                                        alert("Solo se permite JPG o PNG.");
                                                        $(this).val("");
                                                        return;
                                                    }

                                                    const reader = new FileReader();
                                                    reader.onload = function (e) {
                                                        $("#imgUsuarioPreview").attr("src", e.target.result);
                                                        $("#imgUsuarioMain").attr("src", e.target.result);
                                                    };
                                                    reader.readAsDataURL(file);
                                                });

                                                $(document).on("click", ".btn-delete-direccion", function () {
                                                    const idDireccion = $(this).data("direccion-id");
                                                    const token = $("#Token").val();
                                                    if (!idDireccion || !token)
                                                        return;

                                                    Swal.fire({
                                                        title: "¿Eliminar esta dirección?",
                                                        text: "Esta acción no se puede deshacer.",
                                                        icon: "warning",
                                                        showCancelButton: true,
                                                        confirmButtonColor: "#d33",
                                                        cancelButtonColor: "#6c757d",
                                                        confirmButtonText: "Sí, eliminar",
                                                        cancelButtonText: "Cancelar"
                                                    }).then((result) => {
                                                        if (!result.isConfirmed)
                                                            return;

                                                        fetch(API_BASE + "/api/direccion/delete/direccion?IdDireccion=" + encodeURIComponent(idDireccion), {
                                                            method: "DELETE",
                                                            headers: {
                                                                Authorization: `Bearer ${token}`,
                                                                "Content-Type": "application/json"
                                                            }
                                                        })
                                                                .then((r) => {
                                                                    if (!r.ok)
                                                                        throw new Error("Error al eliminar");
                                                                    return r.json();
                                                                })
                                                                .then(() => Swal.fire("Eliminada", "La dirección se eliminó correctamente.", "success")
                                                                            .then(() => window.location.reload()))
                                                                .catch(() => Swal.fire("Error", "No se pudo eliminar", "error"));
                                                    });
                                                });

                                                function FormDireccionNueva() {
                                                    $("#IdDireccion").val("0");
                                                    $("#calle").val("");
                                                    $("#numeroExterior").val("");
                                                    $("#numeroInterior").val("");
                                                    $("#ddlColonia").val("0");
                                                }

                                                function setFormValue(idSelector, value) {
                                                    const v = (value === null || value === undefined) ? "" : String(value);
                                                    const $id = $(idSelector);
                                                    if ($id.length) {
                                                        $id.val(v);
                                                    }
                                                }

                                                function FormDireccionEditable(idDireccion) {
                                                    $("#IdDireccion").val(String(idDireccion || 0));

                                                    const token = ($("#Token").val() || "").trim();

                                                    $.ajax({
                                                        url: "/api/direccion/id?IdDireccion=" + encodeURIComponent(idDireccion) + "&_=" + Date.now(),
                                                        method: "GET",
                                                        dataType: "json",
                                                        cache: false,
                                                        headers: token ? {Authorization: `Bearer ${token}`} : {},
                                                        success: function (data) {
                                                            let d = (data && (data.object || data.Object)) ? (data.object || data.Object) : data;
                                                            if (Array.isArray(d))
                                                                d = d[0];

                                                            const pick = (obj, keys) => {
                                                                for (const k of keys) {
                                                                    if (obj && obj[k] !== undefined && obj[k] !== null)
                                                                        return obj[k];
                                                                }
                                                                return null;
                                                            };

                                                            const idDir = pick(d, ["IdDireccion", "idDireccion"]) ?? idDireccion ?? "0";
                                                            const calle = pick(d, ["Calle", "calle"]) ?? "";
                                                            const numExt = pick(d, ["NumeroExterior", "numeroExterior"]) ?? "";
                                                            const numInt = pick(d, ["NumeroInterior", "numeroInterior"]) ?? "";

                                                            const colObj = pick(d, ["colonia", "Colonia"]) || {};
                                                            const idCol = pick(colObj, ["IdColonia", "idColonia"]);
                                                            const nomCol = pick(colObj, ["Nombre", "nombre"]) || "";

                                                            $("#IdDireccion").val(String(idDir));
                                                            $("#calle").val(calle);
                                                            $("#numeroExterior").val(numExt);
                                                            $("#numeroInterior").val(numInt);

                                                            if (idCol && String(idCol) !== "0") {
                                                                const $ddl = $("#ddlColonia");
                                                                const idColStr = String(idCol);

                                                                if ($ddl.find('option[value="' + idColStr + '"]').length === 0) {
                                                                    const text = nomCol && nomCol.trim() ? nomCol : ("Colonia " + idColStr);
                                                                    $ddl.append(new Option(text, idColStr, true, true));
                                                                }
                                                                $ddl.val(idColStr);
                                                            } else {
                                                                $("#ddlColonia").val("0");
                                                            }
                                                        },
                                                        error: function (xhr) {
                                                            console.error("Error al cargar direccion", xhr.status, xhr.responseText);
                                                        }
                                                    });
                                                }

                                                $(document).on("submit", "#formDireccion", function (e) {
                                                    e.preventDefault();

                                                    const idUsuario = ($("#IdUsuario").val() || "").trim();
                                                    const token = ($("#Token").val() || "").trim();

                                                    const idDireccion = parseInt(($("#IdDireccion").val() || "0").trim(), 10) || 0;
                                                    const idColonia = parseInt(($("#ddlColonia").val() || "0").trim(), 10) || 0;

                                                    const calleVal = ($("#calle").val() || "").trim();
                                                    const numExtVal = ($("#numeroExterior").val() || "").trim();
                                                    const numIntVal = ($("#numeroInterior").val() || "").trim();

                                                    if (!idUsuario) {
                                                        Swal.fire("Error", "No se pudo leer IdUsuario del formulario.", "error");
                                                        return;
                                                    }

                                                    if (!calleVal) {
                                                        Swal.fire("Error", "La calle es obligatoria.", "error");
                                                        return;
                                                    }

                                                    if (!idColonia || idColonia === 0) {
                                                        Swal.fire("Error", "Debes seleccionar una colonia.", "error");
                                                        return;
                                                    }

                                                    const payload = {
                                                        IdDireccion: idDireccion,
                                                        idDireccion: idDireccion,

                                                        IdUsuario: parseInt(idUsuario, 10) || idUsuario,
                                                        idUsuario: parseInt(idUsuario, 10) || idUsuario,

                                                        Calle: calleVal,
                                                        calle: calleVal,

                                                        NumeroExterior: numExtVal,
                                                        numeroExterior: numExtVal,

                                                        NumeroInterior: numIntVal,
                                                        numeroInterior: numIntVal,

                                                        IdColonia: idColonia,
                                                        idColonia: idColonia,

                                                        colonia: {IdColonia: idColonia, idColonia: idColonia}
                                                    };

                                                    Swal.fire({
                                                        title: "Guardando...",
                                                        allowOutsideClick: false,
                                                        didOpen: () => Swal.showLoading()
                                                    });

                                                    fetch(API_BASE + "/api/direccion/add/" + encodeURIComponent(idUsuario), {
                                                        method: "POST",
                                                        headers: {
                                                            ...(token ? {Authorization: `Bearer ${token}`} : {}),
                                                            "Content-Type": "application/json"
                                                        },
                                                        body: JSON.stringify(payload)
                                                    })
                                                            .then(async (r) => {
                                                                let data = null;
                                                                try {
                                                                    data = await r.json();
                                                                } catch (_) {
                                                                }
                                                                if (!r.ok) {
                                                                    const msg = (data && (data.errorMessage || data.ErrorMessage))
                                                                            ? (data.errorMessage || data.ErrorMessage)
                                                                            : "No se pudo guardar";
                                                                    throw new Error(msg);
                                                                }
                                                                return data;
                                                            })
                                                            .then(() => {
                                                                Swal.fire("Listo", "Guardado correctamente.", "success")
                                                                        .then(() => window.location.reload());
                                                            })
                                                            .catch((err) => {
                                                                Swal.fire("Error", err.message || "No se pudo guardar", "error");
                                                            });
                                                });
            </script>

        </div>
    </body>

</html>
