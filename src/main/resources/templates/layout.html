<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title layout:title-pattern="$LAYOUT_TITLE - $CONTENT_TITLE">Sistema</title>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    </head>

    <body class="bg-light">

        <!-- NAV -->
        <header>
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-lg py-3">
                <div class="container">

                    <!-- LOGO -->
                    <a class="navbar-brand fw-bold d-flex align-items-center fs-4" th:href="@{/usuario}">
                        <i class="bi bi-people-fill me-2"></i> Sistema de Usuarios
                    </a>

                    <button class="navbar-toggler border-0 shadow-sm" type="button" data-bs-toggle="collapse"
                            data-bs-target="#navbarMain">
                        <span class="navbar-toggler-icon"></span>
                    </button>

                    <div class="collapse navbar-collapse" id="navbarMain">
                        <ul class="navbar-nav ms-auto gap-2">

                            <!-- ADMIN: Lista & Nuevo -->
                            <li class="nav-item" th:if="${SESSION_ROLE == 'Administrador'}">
                                <a class="nav-link fw-semibold px-3 py-2 rounded-pill" th:href="@{/usuario}">
                                    <i class="bi bi-list-check me-2"></i> Lista de Usuarios
                                </a>
                            </li>

                            <li class="nav-item" th:if="${SESSION_ROLE == 'Administrador'}">
                                <a class="nav-link fw-semibold px-3 py-2 rounded-pill" th:href="@{/usuario/add}">
                                    <i class="bi bi-person-plus-fill me-2"></i> Nuevo Usuario
                                </a>
                            </li>

                            <!-- TODOS LOS ROLES: Carga Masiva -->
                            <li class="nav-item"
                                th:if="${SESSION_ROLE == 'Administrador' 
                                or SESSION_ROLE == 'Usuario' 
                                or SESSION_ROLE == 'Cliente'}">

                                <a class="nav-link fw-semibold px-3 py-2 rounded-pill" th:href="@{/Usuario/CargaMasiva}">
                                    <i class="bi bi-cloud-upload-fill me-2"></i> Carga Masiva
                                </a>
                            </li>

                            <!-- LOGOUT -->
                            <li class="nav-item" th:if="${SESSION_ROLE != null}">
                                <form th:action="@{/logout}" method="post">
                                    <button class="btn btn-light fw-semibold px-3 py-2 rounded-pill">
                                        <i class="bi bi-box-arrow-right me-2"></i>Salir
                                    </button>
                                </form>
                            </li>

                        </ul>
                    </div>

                </div>
            </nav>
        </header>

        <!-- CONTENIDO -->
        <main class="container my-5">
            <div class="card border-0 rounded-4 shadow-lg">
                <div class="card-body p-4" layout:fragment="contenido">
                </div>
            </div>
        </main>

        <!-- FOOTER -->
        <footer class="bg-white border-top shadow-sm py-4 mt-5">
            <div class="container text-center">
                <p class="mb-0 text-muted fw-semibold">
                    <i class="bi bi-c-circle me-1"></i> 2025 Ulises Muñoz Jacobo
                </p>
            </div>
        </footer>

        <!-- SCRIPTS BOOTSTRAP & JQUERY -->
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

        <!-- SELECTS DEPENDIENTES -->
        <script>
            $(document).ready(function () {

                let token = $("#token").val();

                // ---------------- PAIS → ESTADO ----------------
                $("#ddlPais").change(function () {
                    $.ajax({
                        url: "http://localhost:8080/api/estado/pais?IdPais=" + $("#ddlPais").val(),
                        type: "GET",
                        dataType: "JSON",
                        headers: {Authorization: "Bearer " + token},
                        success: function (result) {
                            $("#ddlEstado").empty().append("<option value='0' selected>Selecciona algún Estado</option>");
                            $.each(result.Object, function (i, estado) {
                                $("#ddlEstado").append("<option value='" + estado.idEstado + "'>" + estado.nombre + "</option>");
                            });
                        },
                        error: function () {
                            Swal.fire({
                                icon: "error",
                                title: "Error",
                                text: "No se pudo consultar los estados",
                                confirmButtonColor: "#0d6efd",
                            });
                        },
                    });
                });

                // ---------------- ESTADO → MUNICIPIO ----------------
                $("#ddlEstado").change(function () {
                    $.ajax({
                        url: "http://localhost:8080/api/municipio/estado?IdEstado=" + $("#ddlEstado").val(),
                        type: "GET",
                        dataType: "JSON",
                        headers: {Authorization: "Bearer " + token},
                        success: function (result) {
                            $("#ddlMunicipio").empty().append("<option value='0' selected>Selecciona algún Municipio</option>");
                            $.each(result.Object, function (i, municipio) {
                                $("#ddlMunicipio").append("<option value='" + municipio.idMunicipio + "'>" + municipio.nombre + "</option>");
                            });
                        },
                        error: function () {
                            Swal.fire({
                                icon: "error",
                                title: "Error",
                                text: "No se pudo consultar los municipios",
                                confirmButtonColor: "#0d6efd",
                            });
                        },
                    });
                });

                // ---------------- MUNICIPIO → COLONIA / CP ----------------
                $("#ddlMunicipio").change(function () {
                    $.ajax({
                        url: "http://localhost:8080/api/colonia/municipio?IdMunicipio=" + $("#ddlMunicipio").val(),
                        type: "GET",
                        dataType: "JSON",
                        headers: {Authorization: "Bearer " + token},
                        success: function (result) {

                            $("#ddlColonia")
                                    .empty()
                                    .append("<option value='0' selected>Selecciona alguna colonia</option>");

                            $("#ddlCodigoPostal")
                                    .empty()
                                    .append("<option value='0' selected>Seleccione un Código Postal</option>");

                            $.each(result.Object, function (i, colonia) {
                                $("#ddlColonia").append("<option value='" + colonia.idColonia + "'>" + colonia.nombre + "</option>");
                                $("#ddlCodigoPostal").append("<option value='" + colonia.idColonia + "'>" + colonia.codigoPostal + "</option>");
                            });
                        },
                        error: function () {
                            Swal.fire({
                                icon: "error",
                                title: "Error",
                                text: "No se pudo consultar las colonias",
                                confirmButtonColor: "#0d6efd",
                            });
                        },
                    });
                });

            });
        </script>

    </body>
</html>
